name: Minecraft Docker Image CI

on:
  schedule:
    - cron: '0 0 */3 * *'
  workflow_dispatch:
    inputs:
      MC_VERSION:
        description: '要构建的 Minecraft 版本；指定后将跳过版本自动检测'
        required: false
        default: ''
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: minecraft-folia

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Fetch Folia version info
      id: version_info
      run: |
        set -euo pipefail
        FOLIA_API="https://api.papermc.io/v2/projects/folia"
        if [ -n "${{ github.event.inputs.MC_VERSION }}" ]; then
          MC_VERSION="${{ github.event.inputs.MC_VERSION }}"
          echo ">>> 使用手动指定的 Minecraft 版本: $MC_VERSION"
        else
          echo ">>> 从 Mojang 获取最新 Minecraft 版本..."
          MC_VERSION=$(curl -fsSL https://launchermeta.mojang.com/mc/game/version_manifest.json | jq -r '.latest.release')
          echo ">>> 最新 Minecraft 版本: $MC_VERSION"
        fi
        echo ">>> 获取 Folia 可用版本列表..."
        FOLIA_VERSIONS=$(curl -fsSL "$FOLIA_API" | jq -r '.versions[]')
        if echo "$FOLIA_VERSIONS" | grep -qx "$MC_VERSION"; then
          TARGET_VERSION="$MC_VERSION"
          echo ">>> 找到精确匹配的 Folia 版本: $TARGET_VERSION"
        else
          MAJOR_VERSION=$(echo "$MC_VERSION" | cut -d. -f1-2)
          TARGET_VERSION=$(echo "$FOLIA_VERSIONS" | grep "^${MAJOR_VERSION}" | tail -1 || true)
          if [ -z "$TARGET_VERSION" ]; then
            TARGET_VERSION=$(echo "$FOLIA_VERSIONS" | tail -1)
            echo ">>> 警告: 未找到 $MC_VERSION 的 Folia 版本，使用最新版本: $TARGET_VERSION"
          else
            echo ">>> 使用匹配的 Folia 版本: $TARGET_VERSION (对应 MC $MC_VERSION)"
          fi
        fi
        echo ">>> 获取 Folia $TARGET_VERSION 的构建列表..."
        BUILDS=$(curl -fsSL "$FOLIA_API/versions/${TARGET_VERSION}" | jq -r '.builds[]')
        LATEST_BUILD=$(echo "$BUILDS" | tail -1)
        echo ">>> 最新构建号: $LATEST_BUILD"
        echo ">>> 获取构建详情..."
        BUILD_INFO=$(curl -fsSL "$FOLIA_API/versions/${TARGET_VERSION}/builds/${LATEST_BUILD}")
        JAR_NAME=$(echo "$BUILD_INFO" | jq -r '.downloads.application.name')
        echo ">>> 目标文件: $JAR_NAME"
        echo "TARGET_VERSION=$TARGET_VERSION" >> $GITHUB_ENV
        echo "LATEST_BUILD=$LATEST_BUILD" >> $GITHUB_ENV
        echo "JAR_NAME=$JAR_NAME" >> $GITHUB_ENV

    - name: Check if version is updated
      id: check_version
      run: |
        set -euo pipefail
        # 语义化版本比较函数: 如果 v1 > v2 返回 0，否则返回 1
        version_gt() {
            local v1="$1"
            local v2="$2"
            # 将版本号按点分割成数组
            IFS='.' read -ra V1_PARTS <<< "$v1"
            IFS='.' read -ra V2_PARTS <<< "$v2"
            local len1=${#V1_PARTS[@]}
            local len2=${#V2_PARTS[@]}
            local max_len=$len1
            [ $len2 -gt $max_len ] && max_len=$len2
            for ((i=0; i<max_len; i++)); do
                local p1=0
                local p2=0
                [ $i -lt $len1 ] && p1=${V1_PARTS[$i]}
                [ $i -lt $len2 ] && p2=${V2_PARTS[$i]}
                if [ "$p1" -gt "$p2" ]; then
                    return 0  # v1 > v2
                elif [ "$p1" -lt "$p2" ]; then
                    return 1  # v1 < v2
                fi
            done
            return 1  # v1 == v2
        }
        CURRENT_VERSION="${{ env.TARGET_VERSION }}"
        echo ">>> 当前目标 Minecraft 版本: $CURRENT_VERSION"
        # 手动指定版本时直接构建
        if [ -n "${{ github.event.inputs.MC_VERSION }}" ]; then
          echo ">>> 手动指定版本，强制构建"
          echo "BUILD_NEEDED=true" >> $GITHUB_ENV
          echo "SKIP_VERSION_UPDATE=true" >> $GITHUB_ENV
          exit 0
        fi
        # 读取上次构建版本
        if [ -f last_built_version.txt ]; then
          LAST_BUILT_VERSION=$(cat last_built_version.txt | tr -d '[:space:]')
          echo ">>> 上次构建版本: $LAST_BUILT_VERSION"
        else
          LAST_BUILT_VERSION="0.0.0"
          echo ">>> 无上次构建记录"
        fi
        # 语义化版本比较
        if version_gt "$CURRENT_VERSION" "$LAST_BUILT_VERSION"; then
          echo ">>> 版本已更新 ($LAST_BUILT_VERSION -> $CURRENT_VERSION)，需要构建"
          echo "BUILD_NEEDED=true" >> $GITHUB_ENV
        else
          echo ">>> 版本未变化或更低，跳过构建"
          echo "BUILD_NEEDED=false" >> $GITHUB_ENV
        fi

    - name: Download Folia server.jar
      if: env.BUILD_NEEDED == 'true'
      run: |
        DOWNLOAD_URL="https://api.papermc.io/v2/projects/folia/versions/${{ env.TARGET_VERSION }}/builds/${{ env.LATEST_BUILD }}/downloads/${{ env.JAR_NAME }}"
        echo ">>> 下载 Folia: $DOWNLOAD_URL"
        curl -fsSL -o folia-server.jar "$DOWNLOAD_URL"
        echo ">>> 下载完成，文件大小: $(ls -lh folia-server.jar | awk '{print $5}')"

    - name: Generate random RCON password
      if: env.BUILD_NEEDED == 'true'
      run: |
        RCON_PASSWORD=$(openssl rand -base64 32 | tr -dc 'A-Za-z0-9' | head -c 32)
        echo "RCON_PASSWORD=$RCON_PASSWORD" >> $GITHUB_ENV
        sed -i "s/^rcon.password=.*/rcon.password=${RCON_PASSWORD}/" server.properties
        echo ">>> RCON 密码已更新"

    - name: Prepare Docker tags
      if: env.BUILD_NEEDED == 'true'
      run: |
        REPO_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        if [ -n "${{ github.event.inputs.MC_VERSION }}" ]; then
          TAGS="${{ env.REGISTRY }}/${REPO_LOWER}/${{ env.IMAGE_NAME }}:${{ env.TARGET_VERSION }}"
        else
          TAGS="${{ env.REGISTRY }}/${REPO_LOWER}/${{ env.IMAGE_NAME }}:latest,${{ env.REGISTRY }}/${REPO_LOWER}/${{ env.IMAGE_NAME }}:${{ env.TARGET_VERSION }}"
        fi
        echo "TAGS=$TAGS" >> $GITHUB_ENV
        echo ">>> Docker 标签: $TAGS"

    - name: Build and push Docker image
      if: env.BUILD_NEEDED == 'true'
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ env.TAGS }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Update last built version
      if: env.BUILD_NEEDED == 'true' && env.SKIP_VERSION_UPDATE != 'true'
      run: |
        echo "${{ env.TARGET_VERSION }}" > last_built_version.txt
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git add last_built_version.txt
        if git diff --cached --quiet; then
          echo ">>> 无变更需要提交"
        else
          git commit -m "chore: update Minecraft to ${{ env.TARGET_VERSION }}"
          git push
          echo ">>> 版本记录已更新到: ${{ env.TARGET_VERSION }}"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build summary
      if: always()
      run: |
        echo "================================"
        echo "       构建摘要"
        echo "================================"
        echo "构建状态: ${{ env.BUILD_NEEDED == 'true' && '已执行' || '已跳过' }}"
        echo "Minecraft 版本: ${{ env.TARGET_VERSION || 'N/A' }}"
        echo "Folia 构建号: ${{ env.LATEST_BUILD || 'N/A' }}"
        echo "================================"
