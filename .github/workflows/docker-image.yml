name: Minecraft Docker Image CI

on:
  workflow_dispatch:
    inputs:
      PROJECT_ID:
        description: 'CurseForge项目ID'
        required: true
        type: string
      SERVER_VERSION:
        description: 'Minecraft服务端版本'
        required: true
        type: string
      MOD_LOADERS:
        description: 'Minecraft模组加载器 (fabric/forge)'
        required: true
        default: 'fabric'
        type: string
      JDK_VERSION:
        description: 'Java版本'
        required: true
        default: '21'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      JAR_CATALOG: public
      TEMP_CACHE_CATALOG: /temp/cache/
      CURSEFORGE_API: https://www.curseforge.com/api/v1
      CURSEFORGE_DOWNLOAD_API: https://mediafilez.forgecdn.net/files

    steps:
      - uses: actions/checkout@v4
      - name: Set Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Set QEMU
        uses: docker/setup-qemu-action@v3

      # 验证Modpack是否存在
      - name: Validate Modpack
        run: |
          RESPONSE=$(curl -s "${{ env.CURSEFORGE_API }}/mods/${{ inputs.PROJECT_ID }}/files")
          if [ $(echo "$RESPONSE" | jq -r '.data.id') == null ]; then
            echo "::error::Invalid Project ID"
            exit 1
          fi

      # 登录到容器仓库
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        id: docker-login
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Init Env
        run: |
          sudo mkdir -p ${{ env.JAR_CATALOG }}
          sudo mkdir -p ${{ env.TEMP_CACHE_CATALOG }}
          sudo apt-get -qq -y update

      - name: Set JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.JDK_VERSION }}

      - name: Download and Parse Manifest
        id: manifest
        run: |
          # 翻页参数
          PAGE_INDEX=0
          MAX_PAGES=10
          FOUND_FILE=""
          PROJECT_ID="${{ inputs.PROJECT_ID }}"
          MOD_LOADERS="${{ inputs.MOD_LOADERS }}"
          CURSEFORGE_API="${{ env.CURSEFORGE_API }}"
          SERVER_VERSION="${{ inputs.SERVER_VERSION }}"
          while [[ $PAGE_INDEX -lt $MAX_PAGES ]]; do
            API_URL="${CURSEFORGE_API}/mods/${PROJECT_ID}/files?pageInde=$PAGE_INDEX&pageSize=50&sort=dateCreated&sortDescending=true"
            FILES_JSON=$(curl -s -w "\nHTTP_STATUS:%{http_code}" "${API_URL}")
            HTTP_STATUS=$(echo "$FILES_JSON" | grep 'HTTP_STATUS:' | sed 's/HTTP_STATUS://')
            FILES_JSON=$(echo "$FILES_JSON" | sed '/HTTP_STATUS:/d')
            if [[ "$HTTP_STATUS" != "200" ]]; then
              ((PAGE_INDEX++))
              continue
            fi
            if ! jq -e . >/dev/null 2>&1 <<<"$FILES_JSON"; then
              ((PAGE_INDEX++))
              continue
            fi
            FOUND_FILE=$(echo "$FILES_JSON" | jq -r \
            --arg ver "$SERVER_VERSION" \
            --arg loader "$MOD_LOADERS" '
            .data? // [] |
            map(select(
            .gameVersions != null and
            (
            ([.gameVersions] | flatten | map(select(. != null) | ascii_downcase) | any(. == ($ver | ascii_downcase)))
            and
            ([.gameVersions] | flatten | map(select(. != null) | ascii_downcase) | any(. == ($loader | ascii_downcase)))
            )
            )) |
            if length > 0 then .[0] | {id, fileName} else null end
            ')
            if [[ "$(echo "$FOUND_FILE" | jq -r '.id')" != "null" ]] && [[ -n "$FOUND_FILE" ]]; then
            break
            fi
            ((PAGE_INDEX++))
          done
          if [[ -z "$FOUND_FILE" ]] || [[ "$(echo "$FOUND_FILE" | jq -r '.id')" == "null" ]]; then
            echo "::error::找不到匹配版本 $SERVER_VERSION/$MOD_LOADERS 的modpack文件"
            exit 1
          fi
          FILE_ID=$(echo "$FOUND_FILE" | jq -r '.id')
          FILE_NAME=$(echo "$FOUND_FILE" | jq -r '.fileName')
          FILE_NAME_ENCODE=$(printf '%s' "$FILE_NAME" | jq -sRr '@uri')
          DOWNLOAD_URL="https://mediafilez.forgecdn.net/files/${FILE_ID:0:4}/${FILE_ID:4:3}/$FILE_NAME_ENCODE"
          curl -fL -o modpack.zip "$DOWNLOAD_URL" || {
            echo "::error::下载modpack文件失败"
            exit 1
          }
          unzip -j modpack.zip manifest.json -d . || {
            unzip -l modpack.zip || true
            echo "::error::解压manifest.json失败"
            exit 1
          }
          MANIFEST_JSON=$(jq -c . manifest.json)
          # 规范化镜像名称
          MODPACK_NAME=$(echo "$MANIFEST_JSON" | jq -r '.name')
          # 转换规则：小写化、空格转横线、移除特殊字符 
          NORMALIZED_NAME=$(echo "$MODPACK_NAME" | 
            tr '[:upper:]' '[:lower:]' |
            tr ' ' '-' |
            sed 's/[^a-z0-9_-]//g')
          MODPACK_VERSION=$(echo "$MANIFEST_JSON" | jq -r '.version')
          echo "NORMALIZED_NAME=$NORMALIZED_NAME" >> $GITHUB_ENV
          echo "MODPACK_VERSION=$MODPACK_VERSION" >> $GITHUB_ENV
          echo "MINECRAFT_VERSION=$(jq -r '.minecraft.version' <<< "$MANIFEST_JSON")" >> $GITHUB_ENV
          # 模组列表信息
          MOD_LIST=$(jq -r '
            .files // [] |
            map(select(.projectID? and .fileID?)) |
            map("\(.projectID):\(.fileID)") |
            join(",")
          ' <<< "$MANIFEST_JSON")
          echo "MOD_LIST=$MOD_LIST" >> $GITHUB_ENV
          echo "MOD_LOADER_VERSION=$(jq -r '.minecraft.modLoaders[0].id' <<< "$MANIFEST_JSON" | cut -d- -f2)" >> $GITHUB_ENV
          echo "成功下载版本$SERVER_VERSION的modpack：$FILE_NAME"

      # 下载模组加载器
      - name: Download Mod Loader
        run: |
          case "${{ inputs.MOD_LOADERS }}" in
            fabric)
              # 安装Fabric核心 
              FABRIC_META="https://meta.fabricmc.net/v2/versions"
              LOADER_VER=$(curl -s $FABRIC_META/loader | jq -r '.[0].version')
              INSTALLER_VER=$(curl -s $FABRIC_META/installer | jq -r '.[0].version')
              curl -fSL -o server-core.jar "https://meta.fabricmc.net/v2/versions/loader/${{ env.MINECRAFT_VERSION }}/$LOADER_VER/$INSTALLER_VER/server/jar"
              # 初始化服务端
              java -jar server-core.jar --nogui --universe ${{ env.TEMP_CACHE_CATALOG }}
              ;;
            forge)
              # 安装Forge核心 
              PROMOTION_FILE="https://files.minecraftforge.net/net/minecraftforge/forge/promotions_slim.json"
              FORGE_VERSION=$(curl -s $PROMOTION_FILE | jq -r --arg VER "${{ env.MINECRAFT_VERSION }}" '.promos[$VER + "-latest"]')
              if [ "$FORGE_VERSION" = "null" ]; then
                echo "::error::No Forge version available for ${{ env.MINECRAFT_VERSION }}"
                exit 1
              fi
              # 下载安装器
              curl -fSL -o forge-installer.jar \
                "https://maven.minecraftforge.net/net/minecraftforge/forge/${{ env.MINECRAFT_VERSION }}-$FORGE_VERSION/forge-${{ env.MINECRAFT_VERSION }}-$FORGE_VERSION-installer.jar"
              # 初始化服务端
              java -jar forge-installer.jar --installServer
              mv forge-${{ env.MINECRAFT_VERSION }}-$FORGE_VERSION-universal.jar server-core.jar
              rm -rf server.properties eula.txt README.txt user_jvm_args.txt forge-installer.jar *.log run.bat run.sh
              java -jar server-core.jar --nogui --universe ${{ env.TEMP_CACHE_CATALOG }}
              ;;
            *)
              echo "::error::Unsupported loader: ${{ inputs.MOD_LOADERS }}"
              exit 1
              ;;
          esac

      #  下载 Fabric API
      - name: Download Fabric API
        if: inputs.MOD_LOADERS == 'fabric'
        id: fabric_api_download_url
        run: |
          SERVER_VERSION="${{ inputs.SERVER_VERSION }}"
          # Fabric API 基础 URL 和分页初始化
          PAGE=1
          FABRIC_API_DOWNLOAD_URL=""
          FABRIC_API_BASE_URL="https://api.github.com/repos/FabricMC/fabric/releases?per_page=100"
          # 循环查找版本
          while [[ -z "$FABRIC_API_DOWNLOAD_URL" ]]; do
          # 请求当前页的 Fabric API 版本信息
          FABRIC_API_URL="$FABRIC_API_BASE_URL&page=$PAGE"
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token ${{ secrets.ACTIONS_TOKENS }}" "$FABRIC_API_URL")
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          RESPONSE=$(echo "$RESPONSE" | head -n -1)
          # 输出调试信息
          echo "Fetching page $PAGE: $FABRIC_API_URL"
          echo "HTTP Status: $HTTP_STATUS"
          #echo "Response: $RESPONSE"
          # 检查是否有数据返回或者达到上限
          if [[ "$HTTP_STATUS" == "422" ]]; then
           echo "未找到对应版本"
           break
          elif [[ "$HTTP_STATUS" == "]" ]]; then
           echo "未找到对应版本"
           break
          elif [[ $(echo "$RESPONSE" | jq -r 'length') -eq 0 ]]; then
           echo "未找到对应版本"
           break
          fi
          # 尝试获取与当前 Server 版本匹配的 Fabric API 下载 URL
          MATCHED_RELEASE=$(echo "$RESPONSE" | jq -r --arg SERVER_VERSION "$SERVER_VERSION" '[.[] | select(.target_commitish==$SERVER_VERSION)][0]')
          FABRIC_API_DOWNLOAD_URL=$(echo "$MATCHED_RELEASE" | jq -r '.assets[0].browser_download_url // ""')
          # 增加页码，准备翻页
          PAGE=$((PAGE + 1))
          done
          if [[ -z "$FABRIC_API_DOWNLOAD_URL" ]]; then
          echo "退出Actions"
          exit 1
          fi
          sudo curl -fSL -o ${{ env.JAR_CATALOG }}/fabric-api.jar "$FABRIC_API_DOWNLOAD_URL"

      # 并发下载所有模组文件
      - name: Download Mods in Parallel
        run: |
          echo "${{ env.MOD_LIST }}" | tr ',' '\n' | while IFS=":" read -r PID FID; do
            FOUND_FILE=$(curl -s "${{ env.CURSEFORGE_API }}/mods/$PID/files/$FID")
            FILE_ID=$(echo "$FOUND_FILE" | jq -r '.data.id')
            FILE_NAME=$(echo "$FOUND_FILE" | jq -r '.data.fileName')
            FILE_NAME_ENCODE=$(printf '%s' "$FILE_NAME" | jq -sRr '@uri')
            DOWNLOAD_URL="${{ env.CURSEFORGE_DOWNLOAD_API }}/${FILE_ID:0:4}/${FILE_ID:4:3}/$FILE_NAME_ENCODE"
            printf '%s\t%s\n' "$DOWNLOAD_URL" "$FILE_NAME"
          done > download-list.txt
          sudo sh -c "parallel -j\$(nproc) --colsep '\t' curl -sS -fL \
            -H 'User-Agent: Mozilla/5.0' -H 'Referer: https://curseforge.com/' \
            -o \"\${{ env.JAR_CATALOG }}/{2}\" \"{1}\" :::: download-list.txt"

      # 构建并推送多架构镜像
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.NORMALIZED_NAME }}:${{ env.MODPACK_VERSION }}